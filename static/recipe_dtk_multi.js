//'use strict';

// r  recipe
// rc recipeCard

// dev setup - - - - S
var rcp_single = {"allergens": ["celery", "molluscs", "dairy"], "atomic": false, "components": {}, "description": "squid stuffed w/ chicken spinach pine nuts & cheese topped w/ orange pepper and served with a lemon stock", "dt_date": 1637236261614, "dt_date_readable": "2021 11 18", "dt_day": "thu", "dt_last_update": 0, "dt_rollover": 1637298001614, "dt_time": "1151", "id": 992, "ingredients": [["1", "180g", "(0)", "chicken dark meat"], ["1", "200g", "(0)", "onion"], ["1", "60g", "(0)", "mushrooms"], ["1", "100g", "(0)", "spinach"], ["1", "16g", "(0)", "pine nuts"], ["2", "20g", "(0)", "extra mature cheddar"], ["1", "20g", "(0)", "lemon juice"], ["1", "2g", "(0)", "lemon zest"], ["1", "320g", "(4)", "small squid tubes"], ["1", "40g", "(0)", "red pepper"], ["1", "20g", "(0)", "olive oil"], ["2", "10g", "(0)", "chicken stock cube"], ["1", "200g", "(0)", "water"], ["1", "20g", "(0)", "lemon juice"], ["1", "20g", "(0)", "olive oil"], ["1", "2g", "(0)", "salt"]], "lead_image": "20190516_162549_squid stuffed w chicken and spinach.jpg", "method": "Cook the chicken thigh in a pan until just cooked through then debone & dice it.\nCook the onions until starting to turn brown and add them to the diced chicken.\nDice the mushrooms and cook until golden and add them to the diced chicken.\nAdd the pine nuts to the pan and cook until golden brown. tip: Keep them moving or cook in butter!\nWilt the spinach and drain off excess liquid add them to the diced chicken.\nFinally add the grated cheese & pine nuts and mix into a stuffing mix and the juice and zest of half a lemon and mix well.\nRemove the quill from the squid tubes if present and fill with stuffing.\nPlace in a small baking dish side by side with a slice of lemon between each one\nMix the rest of the ingredients except the pepper into a stock and pour over the squid.\nLay a strip of pepper on each squid and bake in a preheated oven 180C /15m", "notes": "The stuffing comes out a bit and mixes w/ the stock making a great sauce\nMum made this - so so good - a whole pepper going in 20mins before then add the squid for 15m\nThe centre is cooked and going into a hot tray will cook the squid enough in 15m I reckon\nNext time: Use whole red pepper (1 inch dice) and roast for 180C / 35 minutes then add squid\n180C / probe 70C (between filling and squid)", "nutrinfo": {"density": 1, "n_Al": 0.0, "n_Ca": 9.28, "n_En": 265.0, "n_Fa": 15.85, "n_Fb": 1.68, "n_Fm": 7.61, "n_Fo3": 4.58, "n_Fp": 2.87, "n_Fs": 3.35, "n_Pr": 21.69, "n_Sa": 1.61, "n_St": 0.05, "n_Su": 2.89, "serving_size": 115.0, "servings": 4.0, "units": "g", "yield": 460.0}, "ri_id": 99201, "ri_name": "squid stuffed w chicken and spinach", "tags": ["chicken", "shellfish"], "text_file": "20190516_162549_squid stuffed w chicken and spinach.txt", "type": ["snack", "brunch", "component", "amuse", "side", "starter", "sushi", "fish", "lightcourse", "main", "comfort", "low_cal", "serve_rt", "serve_warm"], "user_rating": 1, "user_tags": ["none_listed"], "username": "carter"};
var rcp_guinea_dinner = {"allergens": ["dairy", "celery", "gluten"], "atomic": false, "components": {}, "description": "guinea fowl tagine w couscous & salad", "dt_date": 1637238811912, "dt_date_readable": "2021 11 18", "dt_day": "thu", "dt_last_update": 0, "dt_rollover": 1637298031912, "dt_time": "1233", "id": 513, "ingredients": [["0", "180g", "(0)", "guinea fowl tagine"], ["0", "100g", "(0)", "couscous chermoula"], ["0", "200g", "(0)", "green leaf & orange beet"]], "lead_image": "20200528_163128_guinea fowl tagine w couscous & salad.jpg", "method": "", "notes": "", "nutrinfo": {"density": 1, "n_Al": 0.0, "n_Ca": 14.11, "n_En": 118.0, "n_Fa": 4.27, "n_Fb": 1.63, "n_Fm": 2.31, "n_Fo3": 0.24, "n_Fp": 0.67, "n_Fs": 0.85, "n_Pr": 5.85, "n_Sa": 0.49, "n_St": 0.58, "n_Su": 7.32, "serving_size": 480.0, "servings": 1.0, "units": "g", "yield": 480.0}, "ri_id": 51301, "ri_name": "guinea fowl tagine w couscous & salad", "tags": ["veggie"], "text_file": "20200528_163128_guinea fowl tagine w couscous & salad.txt", "type": ["salad", "main", "comfort", "low_cal", "serve_rt", "serve_warm"], "user_rating": 1, "user_tags": ["none_listed"], "username": "carter"};
var rcp_roast_bird = {"allergens": ["fish"], "atomic": false, "components": {}, "description": "browned guinea fowl coated in chermoula - a north african marinade - cooked until juicy tagine style with mixed veg prunes salted lemon and dates - packed with flavour serve with couscous chermoula", "dt_date": 1637239237949, "dt_date_readable": "2021 11 18", "dt_day": "thu", "dt_last_update": 0, "dt_rollover": 1637298037949, "dt_time": "1240", "id": 998, "ingredients": [["1", "1050g", "(1)", "guinea fowl raw"], ["0", "290g", "(0)", "chermoula"], ["1", "280g", "(0)", "squash"], ["1", "200g", "(0)", "sweet potato"], ["1", "250g", "(0)", "carrots"], ["1", "250g", "(0)", "red onions"], ["1", "36g", "(0)", "prunes"], ["1", "36g", "(0)", "dates"], ["1", "10g", "(0)", "salted lemon"], ["1", "2g", "(0)", "lemon zest"], ["2", "1g", "(0)", "harissa powder"], ["0", "200g", "(0)", "chermoula"], ["1", "400g", "(0)", "water"]], "lead_image": "20200313_133803_guinea fowl tagine.jpg", "method": "Cook the veg for 160C / 30min first \u00a0then add basted bird\nBrown the bird off in frying pan before roasting.\nCoat in chermoula, and place 300g water in the bottom of the tin.\nCover with tin foil roast util probe hits 75C (160C fan / 1h)", "notes": "", "nutrinfo": {"density": 1, "n_Al": 0.0, "n_Ca": 11.89, "n_En": 151.0, "n_Fa": 6.55, "n_Fb": 1.42, "n_Fm": 3.5, "n_Fo3": 0.65, "n_Fp": 1.08, "n_Fs": 1.3, "n_Pr": 11.62, "n_Sa": 0.5, "n_St": 1.37, "n_Su": 6.03, "serving_size": 2280.0, "servings": 1.0, "units": "g", "yield": 2280.0}, "ri_id": 99801, "ri_name": "guinea fowl tagine", "tags": ["fish"], "text_file": "20200313_133803_guinea fowl tagine.txt", "type": ["lunch", "main", "comfort", "serve_warm"], "user_rating": 1, "user_tags": ["none_listed"], "username": "carter"};
var rcp_cherm = {"allergens": ["fish"], "atomic": false, "components": {}, "description": "chermoula is a north african marinade / dip traditionally for fish or seafood but also used for meat and veg, this version is a nod in the right direction - a very tasty nod!", "dt_date": 1637241619978, "dt_date_readable": "2021 11 18", "dt_day": "thu", "dt_last_update": 0, "dt_rollover": 1637298019978, "dt_time": "1320", "id": 942, "ingredients": [["1", "50g", "(0)", "red onion"], ["2", "26g", "(0)", "galangal paste"], ["1", "40g", "(0)", "olive oil"], ["1", "86g", "(0)", "lemon juice"], ["2", "10g", "(0)", "fish sauce"], ["1", "40g", "(0)", "honey"], ["1", "4g", "(0)", "cumin seeds"], ["1", "4g", "(0)", "sweet paprika"], ["1", "4g", "(0)", "turmeric powder"], ["1", "26g", "(0)", "coriander salsa"]], "lead_image": "20200313_133803_chermoula.jpg", "method": "Cut the red onion brunoise and mixall the ingredients together", "notes": "", "nutrinfo": {"density": 1, "n_Al": 0.0, "n_Ca": 19.3, "n_En": 213.0, "n_Fa": 15.79, "n_Fb": 1.47, "n_Fm": 10.8, "n_Fo3": 0.0, "n_Fp": 1.89, "n_Fs": 2.11, "n_Pr": 1.29, "n_Sa": 1.16, "n_St": 0.44, "n_Su": 14.74, "serving_size": 0.0, "servings": -1.0, "units": "g", "yield": 290.0}, "ri_id": 94201, "ri_name": "chermoula", "tags": ["fish"], "text_file": "20200313_133803_chermoula.txt", "type": ["sauce"], "user_rating": 1, "user_tags": ["none_listed"], "username": "carter"};
var rcp_cc = {"allergens": ["celery", "dairy", "gluten"], "atomic": false, "components": {}, "description": "classic marrocan fair this couscous recipe is a GREAT partner to any dish with chermoula flavouring such as guinea fowl tagine / veggie tagine - cracking combo", "dt_date": 1637240301739, "dt_date_readable": "2021 11 18", "dt_day": "thu", "dt_last_update": 0, "dt_rollover": 1637298021739, "dt_time": "1258", "id": 258, "ingredients": [["1", "100g", "(0)", "couscous"], ["1", "200g", "(0)", "water"], ["2", "5g", "(0)", "veg stock cube"], ["1", "26g", "(0)", "flaked almonds"], ["1", "6g", "(0)", "butter"], ["1", "14g", "(0)", "dried cranberries"], ["1", "34g", "(0)", "dried apricots"], ["1", "20g", "(0)", "olives"], ["2", "10g", "(0)", "cocktail onions"], ["1", "2g", "(0)", "mint"], ["1", "1g", "(0)", "salt flakes"]], "lead_image": "20200313_133803_couscous chermoula partner.jpg", "method": "Boil kettle and pour 200ml boiling water into beaker w stock cube and dissolve it\nPlace the couscous in a suitable bowl (should be about an inch deep once stock and couscous mixed) and add the stock.\nPlace a plate over the top an leave until required - at least 20mins.\nChop the mint and dice the rest of the ingredients and mix everything together", "notes": "", "nutrinfo": {"density": 1, "n_Al": 0, "n_Ca": 0, "n_En": 0, "n_Fa": 0, "n_Fb": 0, "n_Fm": 0, "n_Fo3": 0, "n_Fp": 0, "n_Fs": 0, "n_Pr": 0, "n_Sa": 0, "n_St": 0, "n_Su": 0, "serving_size": 0, "servings": 3.0, "units": "g", "yield": 440.0}, "ri_id": 25801, "ri_name": "couscous chermoula", "tags": ["veggie"], "text_file": "none_listed", "type": ["snack", "brunch", "lunch", "salad", "component", "side", "starter", "lightcourse", "main", "serve_warm"], "user_rating": 1, "user_tags": ["none_listed"], "username": "carter"};
var rcp_salad = {"allergens": ["none_listed"], "atomic": false, "components": {}, "description": "green leaf w/ courgette ribbons & mange tout dressed w/ orange beetroot", "dt_date": 1637239132213, "dt_date_readable": "2021 11 18", "dt_day": "thu", "dt_last_update": 0, "dt_rollover": 1637298052213, "dt_time": "1238", "id": 551, "ingredients": [["1", "82g", "(0)", "chinese lettuce"], ["1", "20g", "(0)", "mange tout"], ["1", "50g", "(0)", "mixed green leaf"], ["1", "120g", "(0)", "courgette"], ["0", "100g", "(0)", "orange beetroot"], ["0", "40g", "(0)", "lemon vinaigrette"], ["1", "6g", "(0)", "olive oil"], ["1", "1g", "(0)", "salt flakes"]], "lead_image": "20200528_161914_green leaf & orange beet.jpg", "method": "", "notes": "", "nutrinfo": {"density": 1, "n_Al": 0.0, "n_Ca": 10.84, "n_En": 63.0, "n_Fa": 1.71, "n_Fb": 1.27, "n_Fm": 1.06, "n_Fo3": 0.0, "n_Fp": 0.2, "n_Fs": 0.23, "n_Pr": 1.27, "n_Sa": 0.27, "n_St": 0.0, "n_Su": 9.44, "serving_size": 419.0, "servings": 1.0, "units": "g", "yield": 419.0}, "ri_id": 55101, "ri_name": "green leaf & orange beet", "tags": ["veggie", "vegan"], "text_file": "20200528_161914_green leaf & orange beet.txt", "type": ["salad", "component", "side", "starter", "low_cal", "serve_cold", "serve_rt"], "user_rating": 1, "user_tags": ["none_listed"], "username": "carter"};

var rcps = [rcp_single,rcp_guinea_dinner,rcp_roast_bird,rcp_cherm,rcp_cc,rcp_salad];
//export { rcps as default };

function addNetCarbs(r) {
  r.nutrinfo.n_NtCa = String( (parseFloat(r.nutrinfo.n_Ca) - parseFloat(r.nutrinfo.n_Fb)).toFixed(2));
}
for (let rcp of rcps) {
  //console.log(`${rcp.nutrinfo.n_Ca} - ${rcp.nutrinfo.n_Fb} =`);
  addNetCarbs(rcp);
  //console.log(rcp.nutrinfo.n_NtCa);
}

var ri_id_lookup = {
  '99201': rcp_single,
  '51301': rcp_guinea_dinner,
  '99801': rcp_roast_bird,
  '94201': rcp_cherm,
  '25801': rcp_cc,
  '55101': rcp_salad
}

var ri_id_from_name_lookup = {
  'squid stuffed w chicken and spinach': '99201',
  'guinea fowl tagine w couscous & salad': '51301',
  'guinea fowl tagine': '99801',
  'chermoula': '94201',
  'couscous chermoula': '25801',
  'green leaf & orange beet': '55101',
}

function clickedOnR(e) {
  console.log(`clickedOnR: ${e}`);
}

// _SimulateFetch
function recipeObjectFromName(subcomponentName) {
  console.log(`recipeObjectFromName: ${subcomponentName}`);
  return ri_id_lookup[ri_id_from_name_lookup[subcomponentName]];
}

// dev setup - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - E
// dev setup - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - E
// dev setup - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - E
// dev setup - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - E

import SchemaRecipe from './schema_from_recipe.js';

var recipeToRender = {};               // use hash lookup instead of search
recipes.forEach( r => {
  recipeToRender[r.ri_id] = r;
});
function recipeObjectFromID(ri_id){
  return recipeToRender[ri_id];
}

function recipeComponentFromName(obj, componentName, currentLevel = "components") {
  if (obj.hasOwnProperty(currentLevel)) {
    if (obj[currentLevel].hasOwnProperty(componentName)) {
      return obj[currentLevel][componentName];
    } else {
      for (let key in obj[currentLevel]) {
        let result = recipeComponentFromName(obj[currentLevel][key], componentName);
        if (result) return result;
      }
    }
  }
  return null;
}



// TODO - some characte safety checks
function idFromName(recipeNameString) {
  return recipeNameString.replaceAll(' ','-');
}


function removeRecipeCard(event) {
  const recipeCard = event.target.closest('.rcp-card');
  const parentId = recipeCard.parentElement.id;

  recipeCard.remove();  

  // Tidy up . . Check if parent contains any other recipe cards
  const otherCards = document.querySelectorAll(`#${parentId} .rcp-card`);

  // If no other cards, remove the parent
  if (otherCards.length === 0) {
    document.querySelector(`#${parentId}`).remove();
  }
}


const scrollToCard = function(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); };
// 
function scrollToRecipe(event) {
  //let id = event.target.getAttribute('value');
  let id = event.target.value;
  scrollToCard(id)
}

function addImage(rc, r) {
  let el = document.createElement('img');
  el.classList.add('rcp-image');
  el.src = `static/recipe/${r.lead_image}`;
  el.alt = r.description;  // Add alt tag
  el.title = r.ri_name;    // Add title tag
  //el.src = `https://asset.server:8080/static/recipe/${r.lead_image}`;
  rc.appendChild(el);
}

//<div class="rcp-image-nav">
//    <img class='rcp-image' src='static/images/20190516_162549_squid stuffed w chicken and spinach.jpg'>
//    <button class="btn btn-outline-secondary btn-sm rbut-x" style="">X</button>
//    <button class="btn btn-outline-secondary btn-sm rbut-bk" style=""><</button>
//</div>
//
// plus button call backs
function addImageNav(rc, r) {
  
  let imgNav = document.createElement('div');
  imgNav.classList.add('rcp-image-nav');
    
  addImage(imgNav, r);
  
  if (r.blog_post !== true) { // don't include the X button in blog posts
    let removeB = document.createElement('button');
    removeB.classList.add('btn', 'btn-outline-secondary', 'btn-sm', 'rbut-x');
    removeB.textContent = 'X';
    removeB.addEventListener('click', removeRecipeCard);
    imgNav.appendChild(removeB);
  }

  if (r.back !== null) {
    let bakB = document.createElement('button');
    bakB.classList.add('btn', 'btn-outline-secondary', 'btn-sm', 'rbut-bk');
    bakB.textContent = '<';
    bakB.value = r.back;
    bakB.addEventListener('click', scrollToRecipe);
    imgNav.appendChild(bakB);
  }

  rc.appendChild(imgNav);
  
}

// add Name (for DTK) if different to description
function addNameAndDescription(rc, r) {
  
  // we always want a name
  let elName = document.createElement('div');
  elName.classList.add('rcp-name');
  elName.textContent = r.ri_name;
  rc.appendChild(elName);
  
  if (r.ri_name !== r.description) {
    let el = document.createElement('div');
    el.classList.add('rcp-desc');
    el.textContent = r.description;  
    rc.appendChild(el);
  }
  
}

//  IGDT_TYPE: UNCHECKED / DERIVED / ATOMIC / OTS / DTK
//                 -1         0        1       2     3
const IGD_IDX_TYPE = 0;
const IGD_IDX_QTY  = 1;
const IGD_IDX_EACH = 2;
const IGD_IDX_NAME = 3;

const IGD_TYPE_NO_INFO   = -2;  // should match def in food_sets.py
const IGD_TYPE_UNCHECKED = -1;
const IGD_TYPE_ATOMIC    = 0;
const IGD_TYPE_DERIVED   = 1;
const IGD_TYPE_OTS       = 2;   // Off The Shelf
const IGD_TYPE_DTK       = 3;   // Daily TracKer 

function addIngredients(rc, r){
  let el = document.createElement('div');
  
  // title - makes: Xg - Serves: N
  let elTitle = document.createElement('div');

  elTitle.classList.add('rcp-igds-title');
  let servingsText = (r.nutrinfo.servings === -1) ? '' : ` (${r.nutrinfo.servings})`;
  let innerHTML = `<span>Ingredients</span><span>Makes: ${r.nutrinfo.yield}${r.nutrinfo.units}${servingsText}</span>`;
  elTitle.innerHTML = innerHTML;
  el.appendChild(elTitle);
  
  // table for ingredients
  let elTable = document.createElement('table');
  elTable.classList.add('rcp-tab-igds');
  
  // list of ingredients
  for (let i in r.ingredients) {
    console.log(`IGD: ${i} - ${r.ingredients[i][IGD_IDX_TYPE]} - ${r.ingredients[i][IGD_IDX_QTY]} - ${r.ingredients[i][IGD_IDX_EACH]} - ${r.ingredients[i][IGD_IDX_NAME]} <`);
    // contsturct html for each ingredient line
    let elIgdLine = document.createElement('tr');
    let innerHTML = '';

    if (r.blog_post !== true) {
      innerHTML += '<td class="col-but-all text-center"><button class="btn btn-danger btn-sm delete" style="">X</button></td>';
    }
    innerHTML += `<td class="col-but-qty text-center">${r.ingredients[i][IGD_IDX_QTY]}</td>`;

    let insert = '';
    if (r.ingredients[i][IGD_IDX_EACH] !== '(0)') {
      insert = r.ingredients[i][IGD_IDX_EACH];
    }
    
    innerHTML += `<td class="col-but-qty text-center">${insert}</td>`;
    
    innerHTML += `<td class="col-but-ingdt">${r.ingredients[i][IGD_IDX_NAME]}</td>`;
    
    if (r.blog_post !== true) { 
      innerHTML += '<td class="col-but-all"><button class="btn btn-secondary btn-sm snapshot float-right" style=""><img src="static/png/camera.png" alt="tick" srcset="static/svg/camera.svg"></button></td>';
    } 
    
    if (parseInt(r.ingredients[i][IGD_IDX_TYPE]) === IGD_TYPE_DERIVED) {
      if (r.blog_post !== true) {
        innerHTML += `<td class="col-but-all"><a class="rcp-r btn btn-sm btn-outline-secondary float-right" href="#" role="button" style="" value="${r.ingredients[i][IGD_IDX_NAME]}">R</a></td>`;
      } else {
        let href_id = idFromName(r.ingredients[i][IGD_IDX_NAME]);
        innerHTML += `<td class="col-but-all"><a class="rcp-r btn btn-sm btn-outline-secondary float-right" href="#${href_id}" role="button" style="opacity: 0.5;" value="${r.ingredients[i][IGD_IDX_NAME]}">(recipe below)</a></td>`;
      }

    } else {
      innerHTML += '<td class="col-but-all"></td>';  
    }
    
    elIgdLine.innerHTML = innerHTML;
    
    if (parseInt(r.ingredients[i][IGD_IDX_TYPE]) === IGD_TYPE_DERIVED) {
      console.log(`Adding callback to R ${r.ingredients[i][IGD_IDX_NAME]}`);
      console.log(recipeObjectFromName(r.ingredients[i][IGD_IDX_NAME]));
      
      let rButton = elIgdLine.getElementsByClassName('rcp-r')[0]; // return 1st item in collection
      console.log(rButton);
      
      rButton.addEventListener('click', expandIngredientToRecipeCard );  // TODO mayber better to add listenner to parent list then fire on target parent?
    }
    
    elTable.appendChild(elIgdLine);
  }
  
  el.appendChild(elTable);
  
  rc.appendChild(el);
}

// ingredient R button click handler - add ingredient recipe to display.
// https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#improving_scrolling_performance_with_passive_listeners
function expandIngredientToRecipeCard(event) {
  const subcomponentName = event.target.getAttribute('value');
  const elementId = idFromName(subcomponentName);
  const recipeCard = document.getElementById(elementId);
  const backTo = event.target.closest('.rcp-card').getAttribute('id'); 
  const button = event.target;
  const prePendId = 'rcp-multi-target-';
  const targetContainer = button.closest(`[id^="${prePendId}"]`) //.matches('.container-fluid');
  const recipeId = targetContainer.id.replace(prePendId,'');
  //const targetContainer = button.closest('[id^="recipe_dtk_multi_target"]') //.matches('.container-fluid');
  const compositeRecipe = recipeObjectFromID(recipeId);
  
  console.log(`R Button CLICK <EXPAND> ${event.type} ${subcomponentName} - - - - - S`);
  console.log(`backTo: ${backTo}`);
  console.log(elementId);
  console.log(recipeCard);
  
  if (recipeCard === null) {
    console.log(`Creating recipeCard: ID: ${elementId}`);
    //const recipeObj = recipeObjectFromName(subcomponentName);         // dev stub
    const recipeObj = recipeComponentFromName(compositeRecipe, subcomponentName, "components")     
    
    recipeObj.back = backTo;  // embed return route in recipe
    const recipeCardElement = createRecipeCard(recipeObj);        
    targetContainer.appendChild(recipeCardElement);
  } else {
    console.log(`Found recipeCard: ID: ${elementId}`);
  }
  
  // this doesn't work - as soon as exec leaves the context of this call - page goes to top of screen!?
  //document.getElementById(elementId).scrollIntoView({ behavior: 'smooth' });

  // used a timer to put it in timer queue
  //const scrollToCard = id => { console.log(`scrollToCard: ${id}`); };   
  //const scrollToCard = id => { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); };
  
  setTimeout( scrollToCard , 1, elementId);  // 1ms
  
  console.log(`R Button CLICK <EXPAND> ${event.type} ${event.target.getAttribute('value')} - - - - - E`);
}


//<div class='rcp-method'>
//  <div class='rcp-method-title'>Method</div>
//  <table class='rcp-steps'>
//    <tr><td>Boil kettle and pour 200ml boiling water into beaker w stock cube and dissolve it.</td></tr>
//    <tr><td>Place the couscous in a suitable bowl (should be about an inch deep once stock and couscous mixed) and add the stock.</td></tr>
//    <tr><td>Place a plate over the top an leave until required - at least 20mins.</td></tr>
//    <tr><td>Chop the mint and dice the rest of the ingredients and mix everything together.</td></tr>
//    <tr></tr>
//    <tr></tr>
//    
//  </table>
//</div>
      
function addMethod(rc, r){
  var lines = r.method.split('\n');
  if (lines[0].length === 0) return;
  
  let el = document.createElement('div');
  el.classList.add('rcp-method');

  let elTitle = document.createElement('div');
  elTitle.classList.add('rcp-method-title');
  elTitle.textContent = 'Method';
  el.appendChild(elTitle);
  
  // table for method steps
  let elTable = document.createElement('table');
  elTable.classList.add('rcp-steps');
    
  // list of ingredients
  for (const i of lines) {
    //console.log(`HOW: ${i} <`);
    // add each line of the method
    let elMethodLine = document.createElement('tr');
    elMethodLine.innerHTML = `<tr><td>${i}</td></tr>`;
    
    elTable.appendChild(elMethodLine);
  }
  
  el.appendChild(elTable);
  
  rc.appendChild(el);
}
 
function addRecipeTextSections(rc, r) {
  let el = document.createElement('div');
  el.classList.add('rcp-card-txt');
  
  addNameAndDescription(el, r);
  
  addIngredients(el, r);
  
  addMethod(el, r);
  
  rc.appendChild(el);
}


//<div class='nutrinfo'>
//  <table class='nutrinfo-table'>
//    <tr><th colspan="2">Nutrition Info (per 100g)</th></tr>
//    <tr><td class="nut_macro_sub_cat">Omega 3 oil</td>      <td>0.18</td></tr>
//    .
//    .
//    <tr><td class="nut_macro_cat">Starch</td>               <td>0.01</td></tr>
//    <tr><td class="nut_macro_cat">Fibre</td>                <td>0.01</td></tr>
//  </table>
//</div>

// var _col_span_ 2 or 3
var nutriLut = {
  /*'serving_size': '<tr></th>Nutrition Info</th></th>/100g</th></th>/_serving_size_</th></tr>',*/
  'serving_size': '<tr><th colspan="2">Nutrition Info (per 100g) <br> Serving:_serving_size_g</th></tr>',
  //'recipe_title': '<tr><td colspan="2">_recipe_title_</td></tr>',
  'bar_1': '<tr><td colspan="2" class="nutrinfo-thick-line"></td></tr>',
  'n_En': '<tr><td class="nut_macro_cat">Energy</td><td>_n_En_</td></tr>',                /* Energy in kcal x by 4.184 for (kJ) */
  'bar_2': '<tr><td colspan="2" class="nutrinfo-thin-line"></td></tr>',
  'n_Fa': '<tr><td class="nut_macro_cat">Fat</td><td>_n_Fa_</td></tr>',                   /* Fat */
  'n_Fs': '<tr><td class="nut_macro_sub_cat">Saturates</td><td>_n_Fs_</td></tr>',         /* Fat - saturated */
  'n_Fm': '<tr><td class="nut_macro_sub_cat">Mono-unsaturates</td><td>_n_Fm_</td></tr>',  /* Fat - mono-unsaturates */
  'n_Fp': '<tr><td class="nut_macro_sub_cat">Poly-unsaturates</td><td>_n_Fp_</td></tr>',  /* Fat - poly-unsaturates */
  'n_Fo3': '<tr><td class="nut_macro_sub_cat">Omega 3 oil</td><td>0.18</td></tr>',        /* Fat - omega_3 */
  'n_Ca': '<tr><td class="nut_macro_cat">Carbohydrates</td><td>_n_Ca_</td></tr>',         /* Carbohydrate */
  'n_Su': '<tr><td class="nut_macro_sub_cat">Sugars</td><td>_n_Su_</td></tr>',            /* of which is sugar */
  'n_St': '<tr><td class="nut_macro_cat">Starch</td><td>_n_St_</td></tr>',                /* Starch */
  'n_Fb': '<tr><td class="nut_macro_cat">Fibre</td><td>_n_Fb_</td></tr>',                 /* Fibre */
  'n_Pr': '<tr><td class="nut_macro_cat">Protein</td><td>_n_Pr_</td></tr>',               /* Protein */
  'n_Sa': '<tr><td class="nut_macro_cat">Salt</td><td>_n_Sa_</td></tr>',                  /* Salt */
  'bar_3': '<tr><td colspan="2" class="nutrinfo-thin-line"></td></tr>',
  'n_NtCa': '<tr><td class="nut_macro_cat">Net Carbs</td><td>_n_NtCa_</td></tr>',         /* Net Carb */
  'n_Al': '<tr><td class="nut_macro_cat">Alcohol</td><td>_n_Al_</td></tr>',               /* Alcohol */
  //'servings': 1.0,
  //'units': 'g',
  //'yield': 2280.0,
  //'density': 1,  
};

function addNutrition(rc, r){
  let el = document.createElement('div');
  el.classList.add('nutrinfo');

  let elTable = document.createElement('table');
  elTable.classList.add('nutrinfo-table');

  //let elMethodLine = document.createElement('tr');
  //elMethodLine.innerHTML = nutriLut.serving_size;
  //elTable.appendChild(elMethodLine);
  
  for (const [k, v] of Object.entries(nutriLut)) {
    //console.log(`N_INF: ${k} - ${v} <`);
    // add each line of the method
    let elMethodLine = document.createElement('tr');
    
    let html_with_vals = String(v).replace(`_${k}_`, r.nutrinfo[k]);
    
    elMethodLine.innerHTML = html_with_vals;
    
    elTable.appendChild(elMethodLine);
  }
  
  el.appendChild(elTable);
  
  rc.appendChild(el);
}

//function addItem(rc, r) {
//  let el = document.createElement('');
//  el.classList.add('rcp-');  
//  
//  rc.appendChild(el);
//}

function createRecipeCard(r) {
  let recipeCard = document.createElement('div');
  
  recipeCard.setAttribute("id",idFromName(r.ri_name));
  recipeCard.classList.add('rcp-card');

  const schemaRecipe = new SchemaRecipe(r);

  let schema = document.createElement('script');
  schema.type = 'application/ld+json';  
  schema.textContent = schemaRecipe.generateSchema();

  if (r.blog_post === true) {
    recipeCard.appendChild(schema);   // make it machine readable
  }

  addImageNav(recipeCard, r);
  
  addRecipeTextSections(recipeCard, r);
  
  //addNutrition(recipeCard, r);
  if (r.blog_post !== true) {
    recipeCard.appendChild(document.createElement('hr')) // add separator
  } else {
    recipeCard.appendChild(document.createElement('br')) // add separator
  }

  return recipeCard;
}

//export function loadDTKRecipe(targetContainerID, recipe=rcp_guinea_dinner){
function loadDTKRecipe(targetContainerID, recipe=rcp_guinea_dinner){
  console.log(`Loading Recipe: ${recipe.ri_name}`);

  const subContainer   = document.createElement('div');
  subContainer.id = `rcp-multi-target-${recipe.ri_id}`

  // this shows up in the summary of blogger posts
  const titleForBlog = document.createElement('title'); 
  titleForBlog.textContent = recipe.description;
  subContainer.appendChild(titleForBlog);
  
  const targetContainer = document.getElementById(targetContainerID);  

  recipe.back = null;
  const htmlCard = createRecipeCard(recipe);
  
  //console.log(htmlCard);
  subContainer.appendChild(htmlCard);
  
  targetContainer.appendChild(subContainer);
  console.log('complete');
}


// var compositeRecipe = recipes[11];
// console.log(`==> ${compositeRecipe.ri_name} <==S`);
// console.log(compositeRecipe);
// console.log(`==> ${compositeRecipe.ri_name} <==E`);
// loadDTKRecipe('recipe_dtk_multi_target', compositeRecipe);

recipes.forEach( r => {  
  loadDTKRecipe('recipe_dtk_multi_target', r);
});




//for static html test
//
//window.addEventListener('load', f => {
//  console.log('window: Loaded');
//
//  let rc = createRecipeCard(rcp_single);
//  //console.log(rc);
//  //document.body.appendChild(rc);
//  
//  rcp_guinea_dinner.back = null;
//  rc = createRecipeCard(rcp_guinea_dinner);
//  //let rc = createRecipeCard(rcp_roast_bird);
//  console.log(rc);
//  document.body.appendChild(rc);
//  console.log('complete');
//});
